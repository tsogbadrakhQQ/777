<!doctype html>
<html lang="mn">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>InfoHub Display — Fixed Multi-Sheet Version</title>
<style>
  :root{
    --bg:#071225;--panel:#081827;--muted:#9fb0c8;--accent:#ffbf00;--card:#0b2230;
    --glass: rgba(255,255,255,0.03);
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#041726);color:#e8f1f8;font-family:Inter,Arial,sans-serif}
  header{display:flex;align-items:center;gap:18px;padding:14px 22px;background:linear-gradient(180deg, rgba(0,0,0,0.15), transparent)}
  .brand h1{margin:0;font-size:20px;color:var(--accent)}
  .nav{display:flex;gap:8px;margin-left:auto}
  .tab{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 12px;border-radius:10px;color:#cfe8ff;cursor:pointer;font-weight:600}
  .tab.active{background:linear-gradient(90deg, rgba(255,191,0,0.12), rgba(255,191,0,0.06));box-shadow:0 6px 18px rgba(0,0,0,0.5)}
  main{flex:1;display:grid;grid-template-columns:1fr 360px;gap:22px;padding:22px}
  .stage{background:var(--panel);border-radius:14px;padding:22px;display:flex;flex-direction:column;gap:14px;box-shadow:0 12px 40px rgba(2,8,23,0.6)}
  .carousel{flex:1;position:relative;overflow:hidden;border-radius:12px;padding:18px}
  .slides{width:100%;height:100%;display:flex;gap:18px;transition:transform 0.8s cubic-bezier(.2,.9,.2,1)}
  .slide{min-width:100%;height:100%;display:block}
  .card{background:var(--card);border-radius:12px;padding:18px;box-shadow:0 6px 24px rgba(2,8,23,0.5);height:100%;display:flex;flex-direction:column;gap:10px}
  .card h3{margin:0;font-size:36px}
  .meta{color:var(--muted);font-size:14px}
  .desc{flex:1;color:#dff;opacity:0.95;font-size:18px;line-height:1.3}
  .upcoming{background:var(--glass);padding:12px;border-radius:10px;min-height:120px}
  .badge{display:inline-block;padding:6px 10px;border-radius:999px;background:var(--accent);color:#000;font-weight:800;margin-left:10px;font-size:12px;animation:blink 1.2s infinite}
  @keyframes blink{50%{opacity:.36}}
  .qr img{width:86px;height:86px;border-radius:8px;border:2px solid rgba(255,255,255,0.04)}
  footer{padding:10px 22px;color:var(--muted);font-size:13px;background:linear-gradient(0deg, rgba(0,0,0,0.06), transparent)}
  @media(max-width:1100px){ main{grid-template-columns:1fr;padding:14px} .nav{display:none} }
</style>
</head>
<body>
  <header>
    <div class="brand">
      <h1>InfoHub Display</h1>
      <div style="font-size:12px;color:var(--muted)">Сургуулийн интерактив мэдээлэлийн дэлгэц</div>
    </div>
    <div class="nav" id="nav"></div>
  </header>

  <main>
    <section class="stage">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2 id="panel-title">Хуваарь</h2>
        <div id="clock" style="color:var(--muted)"></div>
      </div>

      <div class="carousel">
        <div class="slides" id="slides"></div>
      </div>

      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="color:var(--muted)">Auto-rotate: <span id="rotateTime">15s</span> • Poll: <span id="pollTime">30s</span></div>
        <div style="display:flex;gap:8px">
          <button id="pauseBtn" class="tab">Pause</button>
          <button id="fsBtn" class="tab">Fullscreen</button>
        </div>
      </div>
    </section>

    <aside style="display:flex;flex-direction:column;gap:12px">
      <div class="upcoming">
        <h4 style="margin:0;color:var(--muted)">Ирэх/Шинэ мэдээ</h4>
        <div id="upcomingList" style="margin-top:8px"></div>
      </div>

      <div class="upcoming">
        <h4 style="margin:0;color:var(--muted)">Сэтгэлзүйчийн цаг</h4>
        <div style="display:flex;gap:10px;align-items:center;margin-top:8px">
          <img id="qrImg" alt="QR" src="">
          <div style="font-size:13px;color:var(--muted)" id="psychMeta"></div>
        </div>
      </div>

      <div class="upcoming">
        <h4 style="margin:0;color:var(--muted)">Товч дүрэм</h4>
        <div id="rules" style="margin-top:8px;color:var(--muted);font-size:14px"></div>
      </div>
    </aside>
  </main>

  <footer>© InfoHub — Google Sheets → CSV • Auto-refresh</footer>

<script>
/* ====== CONFIG: paste your 6 published CSV links here ======
  Make sure each link is the "publish to web -> CSV" link.
  Example:
  'https://docs.google.com/spreadsheets/d/e/2PACX-.../pub?output=csv'
*/
const SHEETS = {
  'Хуваарь': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSgrts7G3yfutqPByCyz0gw33YHTweCjrOk3A5v8tkmUzuGPj1sqDDzbLvqXWh54WYrKK2LFdQV-Pum/pub?output=csv',
  'Дугуйлан': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTFV-kvja5BcUYEl4H5ZFIAZYudK1JGZaz0ndqPSZDGoSdg10puSZe-EgY190RvMK37-lGjougznjAh/pub?gid=1519893758&single=true&output=csv',
  'Сэтгэлзүйч': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTqIMhYvWgLiOqO5qbZTgKjKxTi1JFSud821gQowRFSmyJSve100vTgoNeML7Z65Ee-6o294MNbAVE8/pub?output=csv',
  'Меню': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTWsIQCEfqlMPcHuneu1v-CBbnQKg_eL6s43rZBjoy0TjlNNT2Zd4X8LoYKSiqecO45uOS6MrzX57Ee/pub?output=csv',
  'Дүрэм': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTQzL3643L7rgbwxU2YPEXPCdA4jcoufJrNucTIUw3kGtb4zrA9Oa1B4kokZLrrvwOSW_2uFLlhQedx/pub?output=csv',
  'Эвент': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS_AoqjUNdeXzkdSw5wisix5Z_S6Yw3kLhkK6MXloPvZ-lLUT0EqHPsxhuT1beXQCEBqbGgYDRFrnxI/pub?output=csv'
};

/* INTERVALS */
const POLL_INTERVAL = 30_000;
const ROTATE_INTERVAL = 15_000;
const NEW_WINDOW_MS = 48 * 3600 * 1000;

/* UI refs */
const navEl = document.getElementById('nav');
const slidesEl = document.getElementById('slides');
const panelTitleEl = document.getElementById('panel-title');
const upcomingEl = document.getElementById('upcomingList');
const qrImgEl = document.getElementById('qrImg');
const psychMetaEl = document.getElementById('psychMeta');
const rulesEl = document.getElementById('rules');
const clockEl = document.getElementById('clock');
const pauseBtn = document.getElementById('pauseBtn');
const fsBtn = document.getElementById('fsBtn');
const rotateTimeEl = document.getElementById('rotateTime');
const pollTimeEl = document.getElementById('pollTime');

rotateTimeEl.textContent = (ROTATE_INTERVAL/1000) + 's';
pollTimeEl.textContent = (POLL_INTERVAL/1000) + 's';

const TABS = Object.keys(SHEETS);
let dataCache = [];
let currentTab = TABS[0];
let paused = false;
let rotateTimer=null, pollTimer=null, slideScrollerTimer=null, slideIndex=0;

/* NAV */
TABS.forEach(tab=>{
  const b = document.createElement('button');
  b.className = 'tab' + (tab===currentTab ? ' active' : '');
  b.innerText = tab;
  b.onclick = ()=>{ switchTab(tab); };
  navEl.appendChild(b);
});

/* clock */
function updateClock(){ const n=new Date(); clockEl.textContent = `${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}`; }
setInterval(updateClock,1000); updateClock();

/* pause / fullscreen */
pauseBtn.onclick = ()=>{ paused = !paused; pauseBtn.textContent = paused ? 'Resume' : 'Pause'; };
fsBtn && (fsBtn.onclick = ()=>{ if(!document.fullscreenElement) document.documentElement.requestFullscreen().catch(()=>{}); else document.exitFullscreen().catch(()=>{}); });

/* CSV parser (robust enough for typical Sheets CSV) */
function parseCSV(csv){
  // simple split but tolerates quoted fields with commas/newlines
  const rows = [];
  let cur = '';
  let inQuotes = false;
  const lines = csv.replace(/\r\n/g,'\n').split('\n');
  for(const line of lines){
    const quoteCount = (line.match(/"/g)||[]).length;
    if(inQuotes){ cur += '\n' + line; if(quoteCount % 2 === 1){ inQuotes = false; rows.push(cur); cur=''; } }
    else {
      if(quoteCount % 2 === 1){ inQuotes = true; cur = line; }
      else rows.push(line);
    }
  }
  if(cur) rows.push(cur);
  if(rows.length === 0) return [];
  const header = rows.shift();
  const headers = header.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g).map(h=>h.replace(/^"|"$/g,'').trim());
  return rows.map(r=>{
    const fields = r.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];
    const obj = {};
    headers.forEach((h,i)=>{
      let v = (fields[i]||'').trim();
      v = v.replace(/^"|"$/g,'').replace(/""/g,'"');
      obj[h.trim().toLowerCase()] = v;
    });
    return obj;
  });
}

/* loadAll: fetch each sheet and append category */
async function loadAll(){
  const entries = Object.entries(SHEETS);
  const combined = [];
  for(const [cat,url] of entries){
    try{
      const res = await fetch(url, {cache: 'no-store'});
      if(!res.ok){ console.warn('Sheet fetch failed for',cat,res.status); continue; }
      const txt = await res.text();
      const rows = parseCSV(txt);
      rows.forEach(r => { r.category = cat; combined.push(r); });
    }catch(err){
      console.error('Error fetching sheet',cat,err);
    }
  }
  return combined;
}

/* util isNew */
function isNew(item){
  const t = item.updated_at || item.created_at || item.start_date || item.date;
  if(!t) return false;
  const d = new Date(t);
  if(isNaN(d)) return false;
  return (Date.now() - d.getTime()) <= NEW_WINDOW_MS;
}

/* render slides for currentTab */
function renderSlides(){
  slidesEl.innerHTML = '';
  const rows = dataCache.filter(r => ((r.category||'').trim() === currentTab));
  if(rows.length === 0){
    const empty = document.createElement('div'); empty.className='slide';
    empty.innerHTML = `<div class="card"><h3>Мэдээлэл олдсонгүй</h3><div class="meta">Админаас өгөгдөл оруулна уу</div></div>`;
    slidesEl.appendChild(empty);
    return;
  }
  rows.forEach(r=>{
    const sl = document.createElement('div'); sl.className='slide';
    const card = document.createElement('div'); card.className='card';
    const title = document.createElement('h3'); title.innerHTML = (r.title || r.name || '—');
    if(isNew(r)) title.innerHTML += ` <span class="badge">NEW</span>`;
    const meta = document.createElement('div'); meta.className='meta'; meta.textContent = r.meta || '';
    const desc = document.createElement('div'); desc.className='desc'; desc.innerHTML = r.description || r.details || '';
    if(r.image){ const img = document.createElement('img'); img.src=r.image; img.style.maxHeight='160px'; img.style.borderRadius='8px'; img.style.marginTop='10px'; card.appendChild(img); }
    card.appendChild(title); card.appendChild(meta); card.appendChild(desc);
    sl.appendChild(card); slidesEl.appendChild(sl);
  });
  slidesEl.style.transform = 'translateX(0)'; setupSlideScroller();
}

/* slide scroller within tab */
function setupSlideScroller(){
  if(slideScrollerTimer) { clearInterval(slideScrollerTimer); slideScrollerTimer=null; slideIndex=0; }
  const count = slidesEl.children.length;
  if(count <= 1) return;
  slideIndex = 0;
  slideScrollerTimer = setInterval(()=>{
    if(paused) return;
    slideIndex = (slideIndex + 1) % count;
    slidesEl.style.transform = `translateX(-${slideIndex * 100}%)`;
  }, 8000);
}

/* right rail: upcoming, rules, psych QR */
function renderRightRail(){
  // upcoming events — combine category Эвент or rows with start_date
  const events = dataCache.filter(r => ( (r.category||'').trim() === 'Эвент' ) || r.start_date ).map(r=>{
    return { title: r.title || r.name, start: r.start_date || r.date || '', isNew: isNew(r) };
  });
  events.sort((a,b)=>{
    if(!a.start) return 1;
    if(!b.start) return -1;
    return new Date(a.start) - new Date(b.start);
  });
  upcomingEl.innerHTML = '';
  events.slice(0,5).forEach(e=>{
    const el = document.createElement('div'); el.style.display='flex'; el.style.justifyContent='space-between'; el.style.marginBottom='6px';
    el.innerHTML = `<div style="color:#eaf1f9">${e.title}</div><div style="color:${e.isNew? 'var(--accent)':'var(--muted)'}">${e.start}${e.isNew? ' • NEW':''}</div>`;
    upcomingEl.appendChild(el);
  });

  // rules list
  const rules = dataCache.filter(r => ((r.category||'').trim() === 'Дүрэм'));
  rulesEl.innerHTML = '';
  (rules.slice(0,6)).forEach(r=>{
    const el = document.createElement('div'); el.style.marginBottom='6px';
    el.innerHTML = `<strong style="color:#fff">${r.title || r.name}</strong><div style="color:var(--muted);font-size:13px">${r.description || r.meta || ''}</div>`;
    rulesEl.appendChild(el);
  });
  if(rules.length===0) rulesEl.textContent = 'Дүрмийн товч өгөгдөл алга';

  // psych QR
  const psych = dataCache.find(r => ((r.category||'').trim() === 'Сэтгэлзүйч'));
  if(psych){
    const link = psych.qr_link || psych.link || psych.url || psych.meta || '';
    psychMetaEl.textContent = `${psych.title || 'Сэтгэлзүйч'} • ${psych.meta || ''}`;
    qrImgEl.src = link ? generateQR(link) : generateQR(window.location.href);
  } else {
    psychMetaEl.textContent = 'Сэтгэлзүйчийн мэдээлэл байхгүй';
    qrImgEl.src = generateQR(window.location.href);
  }
}

/* QR */
function generateQR(text){ return `https://chart.googleapis.com/chart?cht=qr&chs=200x200&chl=${encodeURIComponent(text)}&chld=L|1`; }

/* switch tab */
function switchTab(tab){
  currentTab = tab;
  Array.from(navEl.children).forEach(b=>b.classList.toggle('active', b.innerText === tab));
  panelTitleEl.innerText = tab;
  renderSlides();
  renderRightRail();
}

/* load+diff+render loop */
async function refreshAll(){
  const combined = await loadAll();
  if(!combined) return;
  // normalize (lowercase keys) and stringify for diff
  const normalized = combined.map(row=>{
    const out = {};
    for(const k in row) out[k.trim().toLowerCase()] = row[k];
    return out;
  });
  const newStr = JSON.stringify(normalized);
  const oldStr = JSON.stringify(dataCache);
  if(newStr !== oldStr){
    dataCache = normalized;
    // if current tab empty, select first tab with content
    if(!dataCache.some(r => (r.category||'').trim() === currentTab)){
      const firstWith = TABS.find(t => dataCache.some(r => (r.category||'').trim()===t));
      if(firstWith) currentTab = firstWith;
    }
    renderSlides();
    renderRightRail();
  }
}

/* auto rotate tabs */
function startAutoRotate(){
  if(rotateTimer) clearInterval(rotateTimer);
  rotateTimer = setInterval(()=>{ if(paused) return; const idx = TABS.indexOf(currentTab); const next = TABS[(idx+1)%TABS.length]; switchTab(next); }, ROTATE_INTERVAL);
}

/* init */
async function init(){
  // initial render
  renderSlides(); renderRightRail();
  await refreshAll();
  pollTimer = setInterval(refreshAll, POLL_INTERVAL);
  startAutoRotate();
  // set nav active visually
  Array.from(navEl.children).forEach(b=>b.classList.toggle('active', b.innerText === currentTab));
}
init();

/* cleanup */
window.addEventListener('beforeunload', ()=>{
  if(rotateTimer) clearInterval(rotateTimer);
  if(pollTimer) clearInterval(pollTimer);
  if(slideScrollerTimer) clearInterval(slideScrollerTimer);
});
</script>
</body>
</html>
